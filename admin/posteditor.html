<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Editor - NewsHub Admin</title>
    <link rel="stylesheet" href="admin.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="../index.html" class="logo">
                <span class="logo-icon">üì∞</span>
                <span class="logo-text">NewsHub</span>
            </a>
        </div>
        
        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-item">
                <span class="nav-icon">üìä</span>
                <span class="nav-text">Dashboard</span>
            </a>
            <a href="post-editor.html" class="nav-item active">
                <span class="nav-icon">üìù</span>
                <span class="nav-text">New Post</span>
            </a>
            <a href="post-editor.html?manage=true" class="nav-item">
                <span class="nav-icon">üìÑ</span>
                <span class="nav-text">Manage Posts</span>
            </a>
            <a href="#" class="nav-item" onclick="alert('Settings coming soon!')">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-text">Settings</span>
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-info">
                <span class="user-avatar">üë§</span>
                <span class="user-name" id="userName">Admin</span>
            </div>
            <button class="btn btn-sm btn-outline" onclick="logout()">Logout</button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <!-- Header -->
        <header class="admin-header">
            <button class="sidebar-toggle" id="sidebarToggle">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <h1 class="page-title" id="pageTitle">New Post</h1>
            <div class="header-actions">
                <a href="dashboard.html" class="btn btn-outline">‚Üê Back</a>
            </div>
        </header>

        <!-- Content -->
        <div class="admin-content">
            <!-- Manage Posts View -->
            <div id="manageView" style="display: none;">
                <div class="content-section">
                    <div class="section-header">
                        <h2>All Posts</h2>
                        <a href="post-editor.html" class="btn btn-primary">+ New Post</a>
                    </div>
                    <div class="posts-table-wrapper">
                        <table class="posts-table" id="allPostsTable">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Author</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="6" class="loading-cell">
                                        <span class="spinner"></span> Loading posts...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Editor View -->
            <div id="editorView">
                <form id="postForm" class="post-editor">
                    <div class="editor-layout">
                        <!-- Main Editor -->
                        <div class="editor-main">
                            <div class="form-group">
                                <label for="postTitle">Title *</label>
                                <input 
                                    type="text" 
                                    id="postTitle" 
                                    placeholder="Enter post title..."
                                    required
                                >
                            </div>
                            
                            <div class="form-group">
                                <label for="postExcerpt">Excerpt *</label>
                                <textarea 
                                    id="postExcerpt" 
                                    rows="3" 
                                    placeholder="Brief summary of the post..."
                                    required
                                ></textarea>
                                <span class="help-text">This will appear in post previews and search results.</span>
                            </div>
                            
                            <div class="form-group">
                                <label for="postContent">Content *</label>
                                <div class="editor-toolbar">
                                    <button type="button" onclick="insertMarkdown('# ')">H1</button>
                                    <button type="button" onclick="insertMarkdown('## ')">H2</button>
                                    <button type="button" onclick="insertMarkdown('**', '**')">Bold</button>
                                    <button type="button" onclick="insertMarkdown('*', '*')">Italic</button>
                                    <button type="button" onclick="insertMarkdown('> ')">Quote</button>
                                    <button type="button" onclick="insertMarkdown('- ')">List</button>
                                    <button type="button" onclick="insertMarkdown('```\n', '\n```')">Code</button>
                                </div>
                                <textarea 
                                    id="postContent" 
                                    rows="20" 
                                    placeholder="Write your post content here..."
                                    required
                                ></textarea>
                                <span class="help-text">
                                    Use Markdown for formatting. Double newline for paragraphs.
                                </span>
                            </div>
                            
                            <div class="form-group">
                                <label for="postImage">Featured Image URL *</label>
                                <input 
                                    type="url" 
                                    id="postImage" 
                                    placeholder="https://example.com/image.jpg"
                                    required
                                >
                                <span class="help-text">
                                    Use a direct image URL. You can upload images to your repo's assets/images folder.
                                </span>
                            </div>
                        </div>
                        
                        <!-- Sidebar -->
                        <div class="editor-sidebar">
                            <div class="sidebar-panel">
                                <h3>Publish</h3>
                                <div class="panel-content">
                                    <div class="form-group">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="postFeatured">
                                            <span class="checkmark"></span>
                                            Featured Post
                                        </label>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="postDate">Publish Date</label>
                                        <input type="date" id="postDate">
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary btn-block" id="publishBtn">
                                        <span class="btn-text">Publish Post</span>
                                        <span class="btn-loader" style="display: none;">
                                            <span class="spinner"></span>
                                        </span>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="sidebar-panel">
                                <h3>Details</h3>
                                <div class="panel-content">
                                    <div class="form-group">
                                        <label for="postCategory">Category *</label>
                                        <select id="postCategory" required>
                                            <option value="">Select category...</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="postAuthor">Author Name *</label>
                                        <input type="text" id="postAuthor" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="postAuthorImage">Author Image URL</label>
                                        <input 
                                            type="url" 
                                            id="postAuthorImage" 
                                            placeholder="https://i.pravatar.cc/150?u=name"
                                        >
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="postTags">Tags</label>
                                        <input 
                                            type="text" 
                                            id="postTags" 
                                            placeholder="tech, news, ai (comma separated)"
                                        >
                                    </div>
                                </div>
                            </div>
                            
                            <div class="sidebar-panel">
                                <h3>Preview</h3>
                                <div class="panel-content">
                                    <div class="preview-info">
                                        <p><strong>Slug:</strong> <span id="slugPreview">-</span></p>
                                        <p><strong>URL:</strong> <span id="urlPreview">-</span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="deleteModal" style="display: none;">
        <div class="modal-overlay" onclick="closeDeleteModal()"></div>
        <div class="modal-content">
            <h3>Delete Post?</h3>
            <p>Are you sure you want to delete this post? This action cannot be undone.</p>
            <div class="modal-actions">
                <button class="btn btn-outline" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="admin.js"></script>
    <script>
        // Check authentication
        const auth = checkAuth();
        if (!auth) {
            window.location.href = 'index.html';
        }
        
        // Initialize GitHub API
        const github = new GitHubAPI(auth.token, auth.owner, auth.repo);
        
        // State
        let posts = [];
        let categories = [];
        let editingPost = null;
        let postToDelete = null;
        
        // Parse URL params
        const urlParams = new URLSearchParams(window.location.search);
        const isManageMode = urlParams.has('manage');
        const editSlug = urlParams.get('edit');
        
        // Initialize view
        async function init() {
            if (isManageMode) {
                showManageView();
                await loadPosts();
            } else if (editSlug) {
                showEditorView();
                document.getElementById('pageTitle').textContent = 'Edit Post';
                await loadCategories();
                await loadPostForEdit(editSlug);
            } else {
                showEditorView();
                await loadCategories();
                setDefaultDate();
            }
        }
        
        function showManageView() {
            document.getElementById('manageView').style.display = 'block';
            document.getElementById('editorView').style.display = 'none';
            document.getElementById('pageTitle').textContent = 'Manage Posts';
        }
        
        function showEditorView() {
            document.getElementById('manageView').style.display = 'none';
            document.getElementById('editorView').style.display = 'block';
        }
        
        async function loadPosts() {
            try {
                const data = await github.getFile('data/posts.json');
                posts = data.posts || [];
                renderPostsTable();
            } catch (error) {
                console.error('Error loading posts:', error);
                AdminUI.showToast('Failed to load posts', 'error');
            }
        }
        
        async function loadCategories() {
            try {
                const data = await github.getFile('data/categories.json');
                categories = data.categories || [];
                
                const select = document.getElementById('postCategory');
                select.innerHTML = '<option value="">Select category...</option>' +
                    categories.map(cat => `<option value="${cat.slug}">${cat.name}</option>`).join('');
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }
        
        async function loadPostForEdit(slug) {
            try {
                const data = await github.getFile('data/posts.json');
                posts = data.posts || [];
                editingPost = posts.find(p => p.slug === slug);
                
                if (!editingPost) {
                    AdminUI.showToast('Post not found', 'error');
                    return;
                }
                
                // Fill form
                document.getElementById('postTitle').value = editingPost.title;
                document.getElementById('postExcerpt').value = editingPost.excerpt;
                document.getElementById('postContent').value = editingPost.content;
                document.getElementById('postImage').value = editingPost.image;
                document.getElementById('postCategory').value = editingPost.category;
                document.getElementById('postAuthor').value = editingPost.author;
                document.getElementById('postAuthorImage').value = editingPost.authorImage || '';
                document.getElementById('postDate').value = editingPost.date;
                document.getElementById('postFeatured').checked = editingPost.featured || false;
                document.getElementById('postTags').value = (editingPost.tags || []).join(', ');
                
                updatePreview();
                
            } catch (error) {
                console.error('Error loading post:', error);
                AdminUI.showToast('Failed to load post', 'error');
            }
        }
        
        function renderPostsTable() {
            const tbody = document.querySelector('#allPostsTable tbody');
            
            if (posts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-cell">No posts yet. Create your first post!</td></tr>';
                return;
            }
            
            tbody.innerHTML = posts.map(post => `
                <tr>
                    <td>
                        <div class="post-title-cell">
                            ${post.featured ? '<span class="badge">‚≠ê</span>' : ''}
                            <span>${escapeHtml(post.title)}</span>
                        </div>
                    </td>
                    <td><span class="category-badge">${escapeHtml(post.category)}</span></td>
                    <td>${escapeHtml(post.author)}</td>
                    <td>${formatDate(post.date)}</td>
                    <td><span class="status-badge active">Published</span></td>
                    <td>
                        <div class="action-buttons">
                            <a href="post-editor.html?edit=${post.slug}" class="btn btn-sm btn-outline" title="Edit">
                                ‚úèÔ∏è
                            </a>
                            <a href="../post.html?slug=${post.slug}" target="_blank" class="btn btn-sm btn-outline" title="View">
                                üëÅÔ∏è
                            </a>
                            <button type="button" class="btn btn-sm btn-danger" onclick="confirmDelete('${post.slug}')" title="Delete">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        // Form submission
        document.getElementById('postForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('publishBtn');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoader = submitBtn.querySelector('.btn-loader');
            
            btnText.style.display = 'none';
            btnLoader.style.display = 'block';
            submitBtn.disabled = true;
            
            try {
                // Get form data
                const postData = {
                    title: document.getElementById('postTitle').value.trim(),
                    excerpt: document.getElementById('postExcerpt').value.trim(),
                    content: document.getElementById('postContent').value.trim(),
                    image: document.getElementById('postImage').value.trim(),
                    category: document.getElementById('postCategory').value,
                    author: document.getElementById('postAuthor').value.trim(),
                    authorImage: document.getElementById('postAuthorImage').value.trim() || 'https://i.pravatar.cc/150?u=author',
                    date: document.getElementById('postDate').value,
                    featured: document.getElementById('postFeatured').checked,
                    tags: document.getElementById('postTags').value.split(',').map(t => t.trim()).filter(t => t)
                };
                
                // Generate slug
                const slug = editingPost ? editingPost.slug : generateSlug(postData.title);
                
                // Create post object
                const newPost = {
                    id: editingPost ? editingPost.id : Date.now(),
                    slug,
                    ...postData,
                    views: editingPost ? editingPost.views : 0
                };
                
                // Load current posts
                const data = await github.getFile('data/posts.json');
                const currentPosts = data.posts || [];
                
                // Update or add post
                if (editingPost) {
                    const index = currentPosts.findIndex(p => p.slug === editingPost.slug);
                    if (index !== -1) {
                        currentPosts[index] = newPost;
                    }
                } else {
                    currentPosts.unshift(newPost);
                }
                
                // Save to GitHub
                await github.updateFile(
                    'data/posts.json',
                    {
                        posts: currentPosts,
                        lastUpdated: new Date().toISOString()
                    },
                    editingPost ? `Update post: ${newPost.title}` : `Add new post: ${newPost.title}`
                );
                
                AdminUI.showToast(editingPost ? 'Post updated successfully!' : 'Post published successfully!', 'success');
                
                // Redirect after short delay
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1500);
                
            } catch (error) {
                console.error('Error saving post:', error);
                AdminUI.showToast('Failed to save post: ' + error.message, 'error');
                btnText.style.display = 'block';
                btnLoader.style.display = 'none';
                submitBtn.disabled = false;
            }
        });
        
        // Auto-generate slug preview
        document.getElementById('postTitle').addEventListener('input', updatePreview);
        
        function updatePreview() {
            const title = document.getElementById('postTitle').value.trim();
            if (title) {
                const slug = generateSlug(title);
                document.getElementById('slugPreview').textContent = slug;
                document.getElementById('urlPreview').textContent = `post.html?slug=${slug}`;
            }
        }
        
        function generateSlug(title) {
            return title
                .toLowerCase()
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .substring(0, 100);
        }
        
        function setDefaultDate() {
            document.getElementById('postDate').value = new Date().toISOString().split('T')[0];
        }
        
        // Delete functionality
        function confirmDelete(slug) {
            postToDelete = slug;
            document.getElementById('deleteModal').style.display = 'block';
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            postToDelete = null;
        }
        
        document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
            if (!postToDelete) return;
            
            try {
                const data = await github.getFile('data/posts.json');
                const currentPosts = data.posts || [];
                const filteredPosts = currentPosts.filter(p => p.slug !== postToDelete);
                
                await github.updateFile(
                    'data/posts.json',
                    {
                        posts: filteredPosts,
                        lastUpdated: new Date().toISOString()
                    },
                    `Delete post: ${postToDelete}`
                );
                
                AdminUI.showToast('Post deleted successfully!', 'success');
                closeDeleteModal();
                await loadPosts();
                
            } catch (error) {
                console.error('Error deleting post:', error);
                AdminUI.showToast('Failed to delete post', 'error');
            }
        });
        
        // Markdown toolbar
        function insertMarkdown(before, after = '') {
            const textarea = document.getElementById('postContent');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const selection = text.substring(start, end);
            
            const newText = text.substring(0, start) + before + selection + after + text.substring(end);
            textarea.value = newText;
            
            textarea.focus();
            textarea.setSelectionRange(start + before.length, end + before.length);
        }
        
        // Utility functions
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function logout() {
            localStorage.removeItem('newshub_auth');
            sessionStorage.removeItem('newshub_auth');
            window.location.href = 'index.html';
        }
        
        // Sidebar toggle
        document.getElementById('sidebarToggle')?.addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('active');
        });
        
        // Initialize
        init();
    </script>
</body>
</html>
a
