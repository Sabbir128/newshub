<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - NewsHub Admin</title>
    <link rel="stylesheet" href="admin.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="../index.html" class="logo">
                <span class="logo-icon">üì∞</span>
                <span class="logo-text">NewsHub</span>
            </a>
        </div>
        
        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-item active">
                <span class="nav-icon">üìä</span>
                <span class="nav-text">Dashboard</span>
            </a>
            <a href="post-editor.html" class="nav-item">
                <span class="nav-icon">üìù</span>
                <span class="nav-text">New Post</span>
            </a>
            <a href="post-editor.html?manage=true" class="nav-item">
                <span class="nav-icon">üìÑ</span>
                <span class="nav-text">Manage Posts</span>
            </a>
            <a href="#" class="nav-item" onclick="alert('Settings coming soon!')">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-text">Settings</span>
            </a>
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-info">
                <span class="user-avatar">üë§</span>
                <span class="user-name" id="userName">Admin</span>
            </div>
            <button class="btn btn-sm btn-outline" onclick="logout()">Logout</button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <!-- Header -->
        <header class="admin-header">
            <button class="sidebar-toggle" id="sidebarToggle">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <h1 class="page-title">Dashboard</h1>
            <div class="header-actions">
                <a href="post-editor.html" class="btn btn-primary">
                    <span>+</span> New Post
                </a>
            </div>
        </header>

        <!-- Content -->
        <div class="admin-content">
            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üìÑ</div>
                    <div class="stat-info">
                        <span class="stat-value" id="totalPosts">-</span>
                        <span class="stat-label">Total Posts</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìÅ</div>
                    <div class="stat-info">
                        <span class="stat-value" id="totalCategories">-</span>
                        <span class="stat-label">Categories</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚≠ê</div>
                    <div class="stat-info">
                        <span class="stat-value" id="featuredPosts">-</span>
                        <span class="stat-label">Featured</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üëÅÔ∏è</div>
                    <div class="stat-info">
                        <span class="stat-value" id="totalViews">-</span>
                        <span class="stat-label">Total Views</span>
                    </div>
                </div>
            </div>

            <!-- Recent Posts -->
            <div class="content-section">
                <div class="section-header">
                    <h2>Recent Posts</h2>
                    <a href="post-editor.html?manage=true" class="btn btn-sm btn-outline">View All</a>
                </div>
                <div class="posts-table-wrapper">
                    <table class="posts-table" id="recentPostsTable">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Author</th>
                                <th>Date</th>
                                <th>Views</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="loading-cell">
                                    <span class="spinner"></span> Loading posts...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="content-section">
                <h2>Quick Actions</h2>
                <div class="quick-actions">
                    <a href="post-editor.html" class="quick-action-card">
                        <span class="quick-action-icon">üìù</span>
                        <span class="quick-action-text">Create New Post</span>
                    </a>
                    <a href="../index.html" target="_blank" class="quick-action-card">
                        <span class="quick-action-icon">üåê</span>
                        <span class="quick-action-text">View Website</span>
                    </a>
                    <a href="https://github.com/" target="_blank" class="quick-action-card">
                        <span class="quick-action-icon">üêô</span>
                        <span class="quick-action-text">Open GitHub</span>
                    </a>
                    <a href="post-editor.html?manage=true" class="quick-action-card">
                        <span class="quick-action-icon">‚úèÔ∏è</span>
                        <span class="quick-action-text">Edit Posts</span>
                    </a>
                </div>
            </div>

            <!-- Repository Info -->
            <div class="content-section">
                <h2>Repository Information</h2>
                <div class="info-card" id="repoInfo">
                    <div class="info-row">
                        <span class="info-label">Repository:</span>
                        <span class="info-value" id="repoName">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Owner:</span>
                        <span class="info-value" id="repoOwner">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Last Updated:</span>
                        <span class="info-value" id="lastUpdated">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Status:</span>
                        <span class="info-value">
                            <span class="status-badge active">Connected</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Notifications -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="admin.js"></script>
    <script>
        // Check authentication
        const auth = checkAuth();
        if (!auth) {
            window.location.href = 'index.html';
        }
        
        // Initialize GitHub API
        const github = new GitHubAPI(auth.token, auth.owner, auth.repo);
        
        // Load dashboard data
        async function loadDashboard() {
            try {
                // Load posts
                const postsData = await github.getFile('data/posts.json');
                const posts = postsData.posts || [];
                
                // Load categories
                const categoriesData = await github.getFile('data/categories.json');
                const categories = categoriesData.categories || [];
                
                // Update stats
                document.getElementById('totalPosts').textContent = posts.length;
                document.getElementById('totalCategories').textContent = categories.length;
                document.getElementById('featuredPosts').textContent = posts.filter(p => p.featured).length;
                document.getElementById('totalViews').textContent = formatNumber(posts.reduce((sum, p) => sum + (p.views || 0), 0));
                
                // Update repo info
                document.getElementById('repoName').textContent = auth.repo;
                document.getElementById('repoOwner').textContent = auth.owner;
                document.getElementById('lastUpdated').textContent = postsData.lastUpdated 
                    ? new Date(postsData.lastUpdated).toLocaleString()
                    : 'Unknown';
                
                // Render recent posts
                renderRecentPosts(posts.slice(0, 5));
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                AdminUI.showToast('Failed to load dashboard data', 'error');
            }
        }
        
        function renderRecentPosts(posts) {
            const tbody = document.querySelector('#recentPostsTable tbody');
            
            if (posts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-cell">No posts yet. Create your first post!</td></tr>';
                return;
            }
            
            tbody.innerHTML = posts.map(post => `
                <tr>
                    <td>
                        <div class="post-title-cell">
                            ${post.featured ? '<span class="badge">‚≠ê</span>' : ''}
                            <span>${escapeHtml(post.title)}</span>
                        </div>
                    </td>
                    <td><span class="category-badge">${escapeHtml(post.category)}</span></td>
                    <td>${escapeHtml(post.author)}</td>
                    <td>${formatDate(post.date)}</td>
                    <td>${formatNumber(post.views || 0)}</td>
                    <td>
                        <div class="action-buttons">
                            <a href="post-editor.html?edit=${post.slug}" class="btn btn-sm btn-outline" title="Edit">
                                ‚úèÔ∏è
                            </a>
                            <a href="../post.html?slug=${post.slug}" target="_blank" class="btn btn-sm btn-outline" title="View">
                                üëÅÔ∏è
                            </a>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }
        
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function logout() {
            localStorage.removeItem('newshub_auth');
            sessionStorage.removeItem('newshub_auth');
            window.location.href = 'index.html';
        }
        
        // Sidebar toggle for mobile
        document.getElementById('sidebarToggle')?.addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('active');
        });
        
        // Load data
        loadDashboard();
    </script>
</body>
</html>
